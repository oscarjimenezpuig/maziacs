/*
============================================================
  Fichero: zenemigos.c
  Creado: 21-06-2025
  Ultima Modificacion: diumenge, 29 de juny de 2025, 06:54:57
  oSCAR jIMENEZ pUIG                                       
============================================================
*/

#include "zenemigos.h"

static u1 enemigo[ENEMIGOS];
static u1 enemigos=0;
static u1 personaje_visto=0;

Grafico gmaziac[4];

static void gmaziacdef() {
	char* dmf[]={
		"0000000000000001111111111000000000000000",
		"0000000000000111111111111110000000000000",
		"0000000000011111111111111111100000000000",
		"0000000011111111111111111111111100000000",
		"0000001111111111111111111111111111000000",
		"0000111111111111000000001111111111110000",
		"0111111111111100000000000011111111111110",
		"1111111111111100011111100011111111111111",
		"1111111111111100111111110011111111111111",
		"1111111111111001111111111001111111111111",
		"1111111111111001111111111001111111111111",
		"1111111111111001111111111001111111111111",
		"1111111111111001111111111001111111111111",
		"1111111111111001111111111001111111111111",
		"1111111111111001111111111001111111111111",
		"1111111111111100111111110011111111111111",
		"1111111111111110011111100111111111111111",
		"0111111111111110000000000111111111111110",
		"00001111111111110000000011111111111110000",
		"0000001111111111111111111111111111000000",
		"0000000011111111111111111111111100000000",
		"0000000000011111111111111111100000000000",
		"0000000000000111111111111110000000000000",
		"0000000000000001111111111000000000000000",
		"0000000000000011111111111100000000000000",
		"0000000000000011111111111100000000000000",
		"0000000000000111100000011110000000000000",
		"0000000000000111100000011110000000000000",
		"0000000000001111000000001111000000000000",
		"0000000000001111000000001111000000000000",
		"0000000000011110000000000111100000000000",
		"0000000000011110000000000111100000000000",
		"0000000000111100000000000011110000000000",
		"0000000001111000000000000001111000000000",
		"0000000011001100000000000011000110000000",
		"0000000011001100000000000110000001100000",
		"0000000110000110000000001100000000110000",
		"0000001100000011000000001100000000110000",
		"0000011000000001100000011000000000011000",
		"00000101000000100100001001000000001001000"
	};
	gmaziac[0]=grafico_new(40,40,1,'0',dmf);
	char* dmb[]={
		"0000000000000001111111111000000000000000",
		"0000000000000111111111111110000000000000",
		"0000000000011111111111111111100000000000",
		"0000000011111111111111111111111100000000",
		"0000001111111111111111111111111111000000",
		"0000111111111111111111111111111111110000",
		"0111111111111111111111111111111111111110",
		"1111111111111111111111111111111111111111",
		"1111111111111111111111111111111111111111",
		"1111111111111111111111111111111111111111",
		"1111111111111111111111111111111111111111",
		"1111111111111111111111111111111111111111",
		"1111111111111111111111111111111111111111",
		"1111111111111111111111111111111111111111",
		"1111111111111111111111111111111111111111",
		"1111111111111111111111111111111111111111",
		"1111111111111111111111111111111111111111",
		"0111111111111111111111111111111111111110",
		"0000111111111111111111111111111111110000",
		"0000001111111111111111111111111111000000",
		"0000000011111111111111111111111100000000",
		"0000000000011111111111111111100000000000",
		"0000000000000111111111111110000000000000",
		"0000000000000001111111111000000000000000",
		"0000000000000011111111111100000000000000",
		"0000000000000011111111111100000000000000",
		"0000000000000111100000011110000000000000",
		"0000000000000111100000011110000000000000",
		"0000000000001111000000001111000000000000",
		"0000000000001111000000001111000000000000",
		"0000000000011110000000000111100000000000",
		"0000000000011110000000000111100000000000",
		"0000000000111100000000000011110000000000",
		"0000000001111000000000000001111000000000",
		"0000000011001100000000000011000110000000",
		"0000000011001100000000000110000001100000",
		"0000000110000110000000001100000000110000",
		"0000001100000011000000001100000000110000",
		"0000011000000001100000011000000000011000",
		"00000101000000100100001001000000001001000"
	};



	gmaziac[2]=grafico_new(40,40,1,'0',dmb);
	char* dmr[]={
		"0000000000000001111111111000000000000000",
		"0000000000000111111111111110000000000000",
		"0000000000011111111111111111100000000000",
		"0000000011111111111111111111111100000000",
		"0000001111111111111111111111111111000000",
		"0000111111111111111111111111111111110000",
		"0111111111111111111111111111111110001110",
		"1111111111111111111111111111111000000001",
		"1111111111111111111111111111110000000001",
		"1111111111111111111111111111000000000111",
		"1111111111111111111111111111000000011111",
		"1111111111111111111111111111000000111111",
		"1111111111111111111111111111000000111111",
		"1111111111111111111111111111000000011111",
		"1111111111111111111111111111000000000111",
		"1111111111111111111111111111100000000001",
		"1111111111111111111111111111110000000001",
		"0111111111111111111111111111111100001110",
		"0000111111111111111111111111111111110000",
		"0000001111111111111111111111111111000000",
		"0000000011111111111111111111111100000000",
		"0000000000011111111111111111100000000000",
		"0000000000000111111111111110000000000000",
		"0000000000000001111111111000000000000000",
		"0000000000000011111111111100000000000000",
		"0000000000000011111111111100000000000000",
		"0000000000000111100000011110000000000000",
		"0000000000000111100000011110000000000000",
		"0000000000001111000000001111000000000000",
		"0000000000001111000000001111000000000000",
		"0000000000011110000000000111100000000000",
		"0000000000011110000000000111100000000000",
		"0000000000111100000000000011110000000000",
		"0000000001111000000000000001111000000000",
		"0000000011001100000000000011000110000000",
		"0000000011001100000000000110000001100000",
		"0000000110000110000000001100000000110000",
		"0000001100000011000000001100000000110000",
		"0000011000000001100000011000000000011000",
		"00000101000000100100001001000000001001000"
	};
	gmaziac[1]=grafico_new(40,40,1,'0',dmr);
	gmaziac[3]=grafico_flip(gmaziac[1]);
}

static u1 enemigo_igual(u1 id,u2 x,u2 y) {
	//dice si hay un enemigo ocupando dicha posicion
	for(u1 k=0;k<enemigos;k++) {
			Objeto* o=objeto_get(enemigo[k]);
			if(o->x==x && o->y==y && o->id!=id) return 1;
	}
	return 0;
}

static void maziac_coloca(u1 id,u2* x,u2* y) {
	u1 ok=0;
	while(!ok) {
		mundo_rand(x,y);
		ok=!enemigo_igual(id,*x,*y);
	}
}

void maziac_define_uno(u1 id) {
	Objeto dm={id,ENEMIGO,"MAZIAC",0,0,0,{gmaziac,gmaziac+1,gmaziac+2,gmaziac+3},1,NORTH};
	objeto_new(dm);
	Objeto* oe=objeto_get(id);
	maziac_coloca(id,&(oe->x),&(oe->y));
	enemigo[enemigos++]=id;
}

void maziac_define(u1 nivel) {
	static u1 gmdef=0;
	if(!gmdef) {
		gmaziacdef();
		gmdef=1;
	}
	u1 mden=nivel-1;
	enemigos=0;
	for(u1 id=MAZIAC_MIN;id<MAZIAC_MIN+mden;id++) {
		maziac_define_uno(id);
	}
}

static u1 maziac_puede_actuar() {
	static clock_t nueva_actuacion=0;
	if(clock()>nueva_actuacion) {
		nueva_actuacion=clock()+MAZDEL*CLOCKS_PER_SEC;
		return 1;
	}
	return 0;
}

static u1 dir_avance(u1 dir,s1* dx,s1* dy) {
	//aumento del desplazamiento segun la direccion
	*dx=*dy=0;
	switch(dir) {
		case NORTH:
			*dy=-1;
			break;
		case SOUTH:
			*dy=1;
			break;
		case EAST:
			*dx=1;
			break;
		case WEST:
			*dx=-1;
			break;
	}
	return (dx!=0 || dy!=0);
}

static void maziac_avanza(Objeto* m) {
	//se produce avance
	s1 dx,dy;
	dir_avance(m->face,&dx,&dy);
	m->x+=dx;
	m->y+=dy;
}

static u1 personaje_localizado(Objeto* m) {
	//el personaje se encuentra en linea de vision con el maziac
	s1 dx,dy;
	dir_avance(m->face,&dx,&dy);
	u2 x=m->x;
	u2 y=m->y;
	while(1) {
		x+=dx;
		y+=dy;
		if(x==personaje.x && y==personaje.y) return 1;
		else if(mundo_get(x,y)==0) break;
	}
	return 0;
}

static u1 salida_random(u1 salidas) {
	//da una salida random del conjunto de salidas
	u1 sr=NORTH<<(rand()%4);
	while((sr & salidas)==0) {
		if(sr==SOUTH) sr=NORTH;
		else sr=sr<<1;
	}
	return sr;
}
		

static void maziac_posicion(Objeto* m) {
	//movimiento del maziac si no hay localizacion del personaje
	u1 salida=mundo_sal(m->x,m->y);
	u1 resto=salida & (~m->face);
	if(salida & m->face && (resto==0 || rand()%3==0)) {
		maziac_avanza(m);
	} else {
		m->face=salida_random(resto);
	}
}

static void lucha(Objeto* m) {
	u1 victoria=1;
	if(personaje.objeto && (objeto_get(personaje.objeto)->tipo & ARMA)) {
		victoria=6;
		personaje.objeto=0;
	}
	personaje_men_new("YOU FIND A MAZIAC... FIGHT BEGIN!");
	u1 dado=rand()%6+1;
	if(dado<=victoria) {
		personaje_men_new("YOU KILL THE MAZIAC");
		m->activo=0;
		m->x=m->y=0;
	} else {
		personaje_men_new("MAZIAC KILL YOU");
		personaje.activo=0;
		quit=1;
	}
	personaje_visto=1;
}
	
static u1 personaje_aqui(Objeto* m) {
	if(m->x==personaje.x && m->y==personaje.y) {
		if(m->face*personaje.face!=8) {
			m->face=8/personaje.face;
			personaje_visto=1;
		} else {
			lucha(m);
		}
		return 1;
	} 
	return 0;
}

static void maziac_inteligencia(Objeto* m) {
	if(!personaje_aqui(m)) {
		if(personaje_localizado(m)) {
			personaje_visto=1;
			maziac_avanza(m);
		} else {
			maziac_posicion(m);
		}
	}
}

static void maziac_actua_uno(u1 id) {
	Objeto* oe=objeto_get(id);
	if(oe->activo) maziac_inteligencia(oe);
}

u1 maziac_act() {
	personaje_visto=0;
	if(enemigos>0 && maziac_puede_actuar()) {
		for(u1 k=0;k<enemigos;k++) {
			u1 id=enemigo[k];
			maziac_actua_uno(id);
		}
		return 1;
	}
	return 0;
}

u1 maziac_visto() {
	return personaje_visto;
}

void enemigos_free() {
	for(u1 k=0;k<4;k++) {
		grafico_del(gmaziac+k);
	}
}


